<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A simple KML example.">
    <meta name="cesium-sandcastle-labels" content="Showcases, DataSources">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
    require.config({
        baseUrl : '../../../Source',
        waitSeconds : 60
    });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(../templates/bucket.css);
</style>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>

<script id="cesium_sandcastle_script">
function startup(Cesium) {
    'use strict';
//Sandcastle_Begin
function TourPlayer(viewer, datasource) {
  this.datasource = datasource;
  this.viewer = viewer;
  this.activeScenePlayer = null;

  if(this.datasource && this.datasource.kmlTours) {
    this.tour = this.datasource.kmlTours[0];
    this.playlist = this.tour.playlist;
  }

  this.players = {
    'Wait': WaitPlayer,
    'FlyTo': FlyToPlayer
  };

  this.tourStart = new Cesium.Event();
  this.tourEnd = new Cesium.Event();
  this.sceneStart = new Cesium.Event();
  this.sceneEnd = new Cesium.Event();
}

TourPlayer.prototype.play = function(done) {
  if(this.playlist) {
    var self = this;
    this.tourStart.raiseEvent();
    chainPlaylist(this.playlist, this.playEntry.bind(this), function() {
      // Clean player
      self.activeScenePlayer = null;
      self.tourEnd.raiseEvent();
      done && done();
    });
  }
};

TourPlayer.prototype.playEntry = function(entry, index, next) {
  var PlayerConstructor = this.players[entry.entryType];
  var context = {
    player: this,
    playlist: this.playlist,
    index: index
  };

  this.activeScenePlayer = new PlayerConstructor(entry, (function() {
    this.sceneEnd.raiseEvent(entry.entryType, entry.duration);
    next();
  }).bind(this), context);

  this.sceneStart.raiseEvent(entry.entryType, entry.duration);
  this.activeScenePlayer.play();

};

/*
Asynchronous array iterator
*/
function chainPlaylist(playlist, onEach, done) {
  var generator = generate(playlist);

  var next = function(success) {
    if (success === undefined || success) {
      var entry = generator.next();
      if (!entry.done) {
        var v = entry.value;
        onEach(v[0], v[1], next);
      }
      // We've done
      else {
        done();
      }
    }
  };

  // Make a first step
  next();

  function* generate(playlist) {
    for (var i = 0; i < playlist.length; i++) {
      yield [playlist[i], i];
    }
  }
}

//------------------------------------------------------------
function WaitPlayer(scene, done, context) {
  this.scene = scene;
  this.done = done;
  this.context = context;
}

WaitPlayer.prototype.play = function() {
  // Just call the timeout
  this.timer = setTimeout(this.done, this.scene.duration);
};

//------------------------------------------------------------
function FlyToPlayer(scene, done, context) {
  this.scene = scene;
  this.done = done;
  this.context = context;
  this.camera = context.player.viewer.camera;
}

FlyToPlayer.prototype.play = function() {
  var lookAt = this.scene.lookAt;
  var target = lookAt.getBoundingSphere();
  var offset = lookAt.getHeadingPitchRangeCameraOffset();

  this.camera.flyToBoundingSphere(target, {
    offset: offset,
    duration: this.scene.duration,
    complete: this.done
  });
};
//============================================================

var viewer = new Cesium.Viewer('cesiumContainer');
var options = {
    camera : viewer.scene.camera,
    canvas : viewer.scene.canvas
};

Sandcastle.addToolbarMenu([{
    text : 'Fly to eiffel tower',
    onselect : function() {
        viewer.dataSources.add(
            Cesium.KmlDataSource.load('../../SampleData/kml/eiffel-tower-flyto.kml', options))
        .then(function(dataSource){
            var player = new TourPlayer(viewer, dataSource);

                player.sceneStart.addEventListener(function(type, duration) {
                  console.log('start', type, duration);
                });

                player.sceneEnd.addEventListener(function(type, duration) {
                  console.log('end', type, duration);
                });

                player.tourStart.addEventListener(function() {
                  console.log('Tour Start');
                });

                player.tourEnd.addEventListener(function() {
                  console.log('Tour End');
                });

                player.play();
        });
    }
}], 'toolbar');

Sandcastle.reset = function() {
    viewer.dataSources.removeAll();
    viewer.clock.clockRange = Cesium.ClockRange.UNBOUNDED;
    viewer.clock.clockStep = Cesium.ClockStep.SYSTEM_CLOCK;
};
//Sandcastle_End
    Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
    startup(Cesium);
} else if (typeof require === "function") {
    require(["Cesium"], startup);
}
</script>
</body>
</html>
