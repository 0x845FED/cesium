<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Star burst overlapping billboards.">
    <meta name="cesium-sandcastle-labels" content="Showcases">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
        require.config({
                           baseUrl : '../../../Source',
                           waitSeconds : 60
                       });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(../templates/bucket.css);
</style>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar">
    <div id="zoomButtons"></div>
</div>
<script id="cesium_sandcastle_script">
function startup(Cesium) {
"use strict";
//Sandcastle_Begin
var viewer = new Cesium.Viewer('cesiumContainer', {
    selectionIndicator : false
});

// Add labels clustered at the same location
var numBillboards = 28;
for (var i = 0; i < numBillboards; ++i) {
    var position = Cesium.Cartesian3.fromDegrees(-75.59777, 40.03883);
    viewer.entities.add({
        position : position,
        billboard : {
            image : '../images/facility.gif',
            scale : 2.5
        },
        label : {
            text : 'Label' + i,
            show : false
        }
    });
}

var scene = viewer.scene;
var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);

handler.setInputAction(function(movement) {
    // Star burst on left mouse click.
    starBurst(movement.position);
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

handler.setInputAction(function(movement) {
    // Remove the star burst when the mouse exits the circle or show the label of the billboard the mouse is hovering over.
    updateStarBurst(movement.endPosition);
}, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

scene.camera.moveStart.addEventListener(function() {
    // Reset the star burst on camera move because the lines from the center
    // because the line end points rely on the screen space positions of the billboards.
    undoStarBurst();
});

// State saved across mouse click and move events
var starBurstState = {
    pickedEntities : undefined,
    linePrimitive : undefined,
    radius : undefined,
    center : undefined,
    pixelPadding : 10.0
};

function starBurst(mousePosition) {
    if (Cesium.defined(starBurstState.pickedEntities)) {
        return;
    }

    var pickedObjects = scene.drillPick(mousePosition);
    if (!Cesium.defined(pickedObjects) || pickedObjects.length < 2) {
        return;
    }

    var pickedEntities = starBurstState.pickedEntities = [];
    var lines = [];

    var angle = 0.0;
    var angleIncrease;
    var magnitude;
    var magIncrease;
    var maxDimension;

    // Drill pick gets all of the entities under the mouse pointer.
    // Find the billboards and set their pixel offsets in a circle pattern.
    var length = pickedObjects.length;
    for (var i = 0; i < length; ++i) {
        var object = pickedObjects[i];
        if (object.primitive instanceof Cesium.Billboard) {
            if (pickedEntities.length === 0) {
                starBurstState.center = Cesium.Cartesian3.clone(object.primitive.position);
            }

            pickedEntities.push(object);

            if (!Cesium.defined(angleIncrease)) {
                var width = object.primitive.width;
                var height = object.primitive.height;
                maxDimension = Math.max(width, height) * object.primitive.scale + starBurstState.pixelPadding;
                magnitude = maxDimension + maxDimension * 0.5;
                magIncrease = magnitude;
                angleIncrease = maxDimension / magnitude;
            }

            var x = magnitude * Math.cos(angle);
            var y = magnitude * Math.sin(angle);

            var offset = new Cesium.Cartesian2(x, -y);
            object.id.billboard.pixelOffset = offset;
            if (Cesium.defined(object.id.label)) {
                object.id.label.pixelOffset = offset;
            }

            var position = Cesium.SceneTransforms.wgs84ToWindowCoordinates(scene, object.primitive.position);
            position.x += offset.x;
            position.y += offset.y;
            Cesium.SceneTransforms.transformWindowToDrawingBuffer(scene, position, position);
            position.y = scene.drawingBufferHeight - position.y;
            lines.push(Cesium.SceneTransforms.drawingBufferToWgs84Coordinates(scene, position, 0.0));

            angle += angleIncrease;
            if (angle + angleIncrease * 0.5 > Cesium.Math.TWO_PI) {
                magnitude += magIncrease;
                angle = 0.0;
                angleIncrease = maxDimension / magnitude;
            }
        }
    }

    // Add lines from the pick center out to the translated billboard.
    var instances = [];
    length = lines.length;
    for (var j = 0; j < length; ++j) {
        instances.push(new Cesium.GeometryInstance({
            geometry : new Cesium.SimplePolylineGeometry({
                positions : [starBurstState.center, lines[j]],
                followSurface : false,
                granularity : Cesium.Math.PI_OVER_FOUR
            }),
            attributes : {
                color : Cesium.ColorGeometryInstanceAttribute.fromColor(Cesium.Color.WHITE)
            }
        }));
    }

    starBurstState.linePrimitive = scene.primitives.add(new Cesium.Primitive({
        geometryInstances : instances,
        appearance : new Cesium.PerInstanceColorAppearance({
            flat : true,
            translucent : false
        }),
        asynchronous : false
    }));

    viewer.selectedEntity = undefined;
    starBurstState.radius = magnitude + magIncrease;
}

function updateStarBurst(mousePosition) {
    if (!Cesium.defined(starBurstState.pickedEntities)) {
        return;
    }

    // Remove the star burst if the mouse exits the screen space circle.
    // If the mouse is inside the circle, show the label of the billboard the mouse is hovering over.
    var screenPosition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(scene, starBurstState.center);
    if (Cesium.Cartesian2.distance(mousePosition, screenPosition) > starBurstState.radius) {
        undoStarBurst();
    } else {
        showLabels(mousePosition);
    }
}

function undoStarBurst() {
    var pickedEntities = starBurstState.pickedEntities;
    if (!Cesium.defined(pickedEntities)) {
        return;
    }

    // Reset billboard and label pixel offsets.
    // Hide overlapping labels.
    for (var i = 0; i < pickedEntities.length; ++i) {
        var entity = pickedEntities[i].id;
        entity.billboard.pixelOffset = new Cesium.Cartesian2(0.0, 0.0);
        if (Cesium.defined(entity.label)) {
            entity.label.pixelOffset = new Cesium.Cartesian2(0.0, 0.0);
            entity.label.show = false;
        }
    }

    // Remove lines from the scene.
    // Free resources and reset state.
    scene.primitives.remove(starBurstState.linePrimitive);
    starBurstState.linePrimitive = undefined;
    starBurstState.pickedEntities = undefined;
    starBurstState.radius = undefined;
}

var currentObject;

function showLabels(mousePosition) {
    var pickedObject = scene.pick(mousePosition);
    if (pickedObject !== currentObject) {
        if (Cesium.defined(pickedObject) && pickedObject.primitive instanceof Cesium.Billboard && Cesium.defined(pickedObject.id.label)) {
            if (Cesium.defined(currentObject)) {
                currentObject.id.label.show = false;
            }

            currentObject = pickedObject;
            pickedObject.id.label.show = true;
            pickedObject.id.label.eyeOffset = new Cesium.Cartesian3(0.0, 0.0, -100.0);
        } else if (Cesium.defined(currentObject)) {
            currentObject.id.label.show = false;
            currentObject = undefined;
        }
    }
}

//Sandcastle_End
Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
startup(Cesium);
} else if (typeof require === "function") {
require(["Cesium"], startup);
}
</script>
</body>
</html>