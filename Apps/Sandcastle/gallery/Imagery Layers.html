<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Layer imagery from multiple sources and adjust the alpha of each independently.">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script data-dojo-config="async: 1, tlmSiblingOfDojo: 0" src="../../../ThirdParty/dojo-release-1.7.2-src/dojo/dojo.js"></script>
    <script type="text/javascript">
    require({
        baseUrl : '../../..',
        packages: [
            { name: 'dojo', location: 'ThirdParty/dojo-release-1.7.2-src/dojo' },
            { name: 'dijit', location: 'ThirdParty/dojo-release-1.7.2-src/dijit' },
            { name: 'dojox', location: 'ThirdParty/dojo-release-1.7.2-src/dojox' },
            { name: 'Core', location: 'Source/Core' },
            { name: 'DynamicScene', location: 'Source/DynamicScene' },
            { name: 'Renderer', location: 'Source/Renderer' },
            { name: 'Scene', location: 'Source/Scene' },
            { name: 'Shaders', location: 'Source/Shaders' },
            { name: 'ThirdParty', location: 'Source/ThirdParty' },
            { name: 'Widgets', location: 'Source/Widgets' },
            { name: 'Workers', location: 'Source/Workers' }
        ]
    });
    </script>
    <link rel="Stylesheet" href="../../../ThirdParty/dojo-release-1.7.2-src/dijit/themes/claro/claro.css" type="text/css">
    <link rel="Stylesheet" href="../../../Source/Widgets/Dojo/CesiumViewerWidget.css" type="text/css">
</head>
<body class="claro" data-sandcastle-bucket="bucket-dojo.html" data-sandcastle-title="Cesium + Dojo">
<style>
body {
	background: #000;
	color: #eee;
	font-family: sans-serif;
	font-size: 9pt;
	padding: 0;
	margin: 0;
	width: 100%;
	height: 100%;
	overflow: hidden;
}

.fullSize {
	display: block;
	position: absolute;
	top: 0;
	left: 0;
	border: none;
	width: 100%;
	height: 100%;
	z-index: -1;
}

#toolbar {
	margin: 5px;
	padding: 2px 5px;
	position: absolute;
}

.upArrow {
	background-image: url("../../../Images/UpArrow.png");
	background-repeat: no-repeat;
	width: 16px;
	height: 16px;
	text-align: center;
}

.downArrow {
	background-image: url("../../../Images/DownArrow.png");
	background-repeat: no-repeat;
	width: 16px;
	height: 16px;
	text-align: center;
}
</style>

	<div id="cesiumContainer" class="fullSize"></div>
	<div id="toolbar">Loading...</div>

	<script id="cesium_sandcastle_script">
require([
    'Source/Cesium',
    'Widgets/Dojo/CesiumViewerWidget',
    'dojo/on',
    'dojo/dom',
    'dojo/dom-construct',
    'dijit/form/Button',
    'dijit/form/CheckBox',
    'dijit/form/HorizontalSlider'
], function(
    Cesium,
    CesiumViewerWidget,
    on,
    dom,
    domConstruct,
    Button,
    CheckBox,
    HorizontalSlider)
{
    "use strict";

    var ellipsoid = Cesium.Ellipsoid.WGS84;
    var scene; 
    var cb;
    var mousePosition;
    var camera;
    var position;
    var direction;
    var up;

    function keydownHandler(e) {
        switch (e.keyCode) {
        case 'F'.charCodeAt(0):
            cb._surface.debugToggleLodUpdate();
            break;
        case 'B'.charCodeAt(0):
            camera = scene.getCamera();
            var pickRay = camera.getPickRay(mousePosition);
            var intersectionDistance = Cesium.IntersectionTests.rayEllipsoid(pickRay, ellipsoid).start;
            var intersectionPoint = pickRay.getPoint(intersectionDistance);
            var cartographicPick = ellipsoid.cartesianToCartographic(intersectionPoint);
            cb._surface.debugShowBoundingSphereOfTileAt(cartographicPick);
            break;
        case 'V'.charCodeAt(0):
            camera = scene.getCamera();
            console.log('position: ' + camera.getPositionWC() + ' direction: ' + camera.getDirectionWC() + ' up: ' + camera.getUpWC());
            break;
        case 'L'.charCodeAt(0):
            position = new Cesium.Cartesian3(-2444822.7410362503, -4495391.442027786, 3800016.0770029235);
            direction = new Cesium.Cartesian3(0.2306406390807245, 0.8212545213405562, 0.5218677100397503);
            up = new Cesium.Cartesian3(-0.31881470184216937, -0.44294118336776583, 0.8379500545772692);
            camera = scene.getCamera();
            camera.lookAt(position, position.add(direction), up);
            break;
        case 'C'.charCodeAt(0):
            position = new Cesium.Cartesian3(-2444319.744271441, -4490462.305656268, 3800605.179680734);
            direction = new Cesium.Cartesian3(0.3079076572929976, 0.5183187255969877, 0.7978336751954334);
            up = new Cesium.Cartesian3(-0.38141711164833125, -0.7009912978668698, 0.6026045031832784);
            camera = scene.getCamera();
            camera.lookAt(position, position.add(direction), up);
            break;
        }
    }

    var radarLayer;
    var infraredLayer;
    var singleImageLayer;
    
    var layerNames = {};
    var removedLayers = [];
    
    function createLayerToolbar(imageryLayerCollection, layer, i) {
        new CheckBox({
            checked: removedLayers.indexOf(layer) < 0,
            onChange: function(b) {
                if (b) {
                    imageryLayerCollection.add(layer);
                    removedLayers.splice(removedLayers.indexOf(layer), 1);
                    updateToolbar(imageryLayerCollection);
                } else {
                    imageryLayerCollection.remove(layer, false);
                    removedLayers.push(layer);
                    updateToolbar(imageryLayerCollection);
                }
            }
        }).placeAt('layerToggle' + i);

        new HorizontalSlider({
            value: layer.alpha,
            minimum: 0.0,
            maximum: 1.0,
            intermediateChanges: true,
            style: "width:150px;",
            onChange: function(value) {
                layer.alpha = value;
            }
        }).placeAt('layerSlider' + i);

        var layerIndex = imageryLayerCollection.indexOf(layer);
        var showRaise = layerIndex >= 0 && layerIndex < imageryLayerCollection.getLength() - 1;
        var showLower = layerIndex > 1;

        new Button({
            label: "Raise",
            showLabel: false,
            iconClass: "upArrow",
            style: (showRaise ? "" : "visibility:hidden"),
            onClick: function() {
                if (showRaise) {
                    imageryLayerCollection.raise(layer);
                    updateToolbar(imageryLayerCollection);
                    }
                }
        }).placeAt('layerUpArrow' + i);

        new Button({
            label: "Lower",
            showLabel: false,
            iconClass: "downArrow",
            style: (showLower ? "" : "visibility:hidden"),
            onClick: function() {
                if (showLower) {
                  imageryLayerCollection.lower(layer);
                  updateToolbar(imageryLayerCollection);
                }
            }
        }).placeAt('layerDownArrow' + i);
    }

    function updateToolbar(imageryLayerCollection) {
        domConstruct.place(
                '<table id="layerTable">' +
                  '<tr><td id="layerToggle2"></td><td id="layerLabel2"></td><td id="layerSlider2"></td><td id="layerUpArrow2"></td><td id="layerDownArrow2"></td></tr>' +
                  '<tr><td id="layerToggle1"></td><td id="layerLabel1"></td><td id="layerSlider1"></td><td id="layerUpArrow1"></td><td id="layerDownArrow1"></td></tr>' +
                  '<tr><td id="layerToggle0"></td><td id="layerLabel0"></td><td id="layerSlider0"></td><td id="layerUpArrow0"></td><td id="layerDownArrow0"></td></tr>' +
                '</table>', 'layerTable', 'replace');
        
        var allLayers = removedLayers.slice(0);
        var i, len;
        for (i = 1, len = imageryLayerCollection.getLength(); i < len; ++i) {
            allLayers.push(imageryLayerCollection.get(i));
        }
        
        for (i = allLayers.length - 1; i >= 0; --i) {
            var layer = allLayers[i];
            var imageryProvider = layer.getImageryProvider();

            var layerName = layerNames[imageryProvider.getUrl()];
            domConstruct.place('<span>' + layerName + '</span>', 'layerLabel' + i);

            createLayerToolbar(imageryLayerCollection, layer, i);
        }
    }

    var cesiumViewerWidget = new CesiumViewerWidget({
        postSetup : function(widget) {
            scene = widget.scene;
            cb = scene.getPrimitives().getCentralBody();
            cb.logoOffset = new Cesium.Cartesian2(300, 30);

            widget.cbLighting.set('checked', true);
            
            var imageryLayerCollection = cb.getImageryLayers();
            
            var infrared = new Cesium.WebMapServiceImageryProvider({
                url : 'http://mesonet.agron.iastate.edu/cgi-bin/wms/goes/conus_ir.cgi?',
                layers : 'goes_conus_ir',
                credit : 'Infrared data courtesy Iowa Environmental Mesonet',
                parameters : {
                    transparent : 'true',
                    format : 'image/png'
                },
                proxy : new Cesium.DefaultProxy('/proxy/')
            });
            infraredLayer = imageryLayerCollection.addImageryProvider(infrared);
            infraredLayer.alpha = 0.5;
            layerNames[infrared.getUrl()] = 'United States GOES infrared';

            var radar = new Cesium.WebMapServiceImageryProvider({
                url : 'http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?',
                layers : 'nexrad-n0r',
                credit : 'Radar data courtesy Iowa Environmental Mesonet',
                parameters : {
                    transparent : 'true',
                    format : 'image/png'
                },
                proxy : new Cesium.DefaultProxy('/proxy/')
            });
            radarLayer = imageryLayerCollection.addImageryProvider(radar);
            radarLayer.alpha = 0.5;
            layerNames[radar.getUrl()] = 'United States weather radar';
            
            var singleImage = new Cesium.SingleTileImageryProvider({
                url : '../../../Images/TestLayer.png',
                extent : new Cesium.Extent(
                        Cesium.Math.toRadians(-115.0),
                        Cesium.Math.toRadians(38.0),
                        Cesium.Math.toRadians(-108.0),
                        Cesium.Math.toRadians(45.0))
            });
            singleImageLayer = imageryLayerCollection.addImageryProvider(singleImage);
            layerNames[singleImage.getUrl()] = 'Single image';

            document.addEventListener('keydown', keydownHandler, false);
            
            var handler = new Cesium.EventHandler(widget.canvas);

            handler.setMouseAction(function(movement) {
                mousePosition = movement.endPosition;
                // Use movement.startPosition, movement.endPosition
            }, Cesium.MouseEventType.MOVE);

            domConstruct.place('<table id="layerTable"></table>', 'toolbar');
            updateToolbar(imageryLayerCollection);

            widget.startRenderLoop();
        }
    }).placeAt(dom.byId("cesiumContainer"));
    
    dom.byId('toolbar').innerHTML = '';
});
</script>
</body>
</html>
