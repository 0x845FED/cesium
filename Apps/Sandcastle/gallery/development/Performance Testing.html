<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Measure 3D Tiles streaming and rendering performance.">
    <meta name="cesium-sandcastle-labels" content="Development">
    <title>Streaming Performance Testing</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
        if(typeof require === "function") {
            require.config({
                baseUrl : '../../../Source',
                waitSeconds : 120
            });
        }
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(../templates/bucket.css);
</style>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
function startup(Cesium) {
    'use strict';
//Sandcastle_Begin
var viewer = new Cesium.Viewer('cesiumContainer');
var scene = viewer.scene;
var camera = scene.camera;
var globe = scene.globe;
var statistics = Cesium.RequestScheduler.statistics;

var startTime;
var flightComplete;
var monitor;
var minFrameRate = 1000;
var maxFrameRate = 0;
var sumFrameRate = 0.0;
var frameRateSamples = 0;

function startTest() {
    flightComplete = false;
    minFrameRate = 1000;
    maxFrameRate = 0;
    sumFrameRate = 0.0;
    frameRateSamples = 0;
    statistics.numberOfActiveRequestsEver = 0;
    monitor = new Cesium.FrameRateMonitor({
        scene: scene,
        samplingWindow: 1.0,
        quietPeriod: 0.0,
        warmupPeriod: 0.0,
        minimumFrameRateDuringWarmup: 0,
        minimumFrameRateAfterWarmup: 0
    });
    scene.preUpdate.addEventListener(measureFrameRate);
    startTime = window.performance.now();
    window.setTimeout(function() {
        scene.postRender.addEventListener(viewReady);
    }, 500);
}

function measureFrameRate() {
    var frameRate = monitor.lastFramesPerSecond;
    if (frameRate === undefined || frameRate !== frameRate) {
        return;
    }

    ++frameRateSamples;
    sumFrameRate += frameRate;
    minFrameRate = Math.min(minFrameRate, frameRate);
    maxFrameRate = Math.max(maxFrameRate, frameRate);
}

function viewReady(scene, time) {
    var globeReady = true;
    var tilesetReady = true;
    if (globe != undefined) {
        globeReady = globe._surface.tileProvider.ready && globe._surface._tileLoadQueueHigh.length === 0 && globe._surface._tileLoadQueueMedium.length === 0 && globe._surface._tileLoadQueueLow.length === 0 && globe._surface._debug.tilesWaitingForChildren === 0;
    }
    if (tileset != undefined) {
        tilesetReady = tileset.tilesLoaded;
    }

    if (flightComplete && globeReady && tilesetReady) {
        var endTime = window.performance.now();
        var duration = endTime - startTime;
        if (isNaN(sumFrameRate / frameRateSamples)) {
            // We should really just be computing a running average of FPS instead of "samples".
            alert((duration / 1000).toFixed(2) + ' seconds ' + statistics.numberOfActiveRequestsEver + ' requests. Not enough time for FPS average');
        } else {
            alert((duration / 1000).toFixed(2) + ' seconds ' + statistics.numberOfActiveRequestsEver + ' requests, min/max/avg frame FPS ' + minFrameRate.toFixed(0) + '/' + maxFrameRate.toFixed(0) + '/' + (sumFrameRate / frameRateSamples).toFixed(0));
        }
        
        scene.postRender.removeEventListener(viewReady);
        scene.preUpdate.removeEventListener(measureFrameRate);
    }
}

Sandcastle.addToolbarButton('0', function() {
    // Paste camera position here
    startTest();
    // Paste camera fly to here
});

Sandcastle.addToolbarButton('Print flyto', function() {
    var position = camera.position;
    var direction = camera.direction;
    var up = camera.up;

    var cameraString = 'camera.flyTo({\n\
        destination : new Cesium.Cartesian3(' + position.x + ', ' + position.y + ', ' + position.z + '),\n\
        orientation : {\n\
            direction : new Cesium.Cartesian3(' + direction.x + ', ' + direction.y + ', ' + direction.z + '),\n\
            up : new Cesium.Cartesian3(' + up.x + ', ' + up.y + ', ' + up.z + '),\n\
        },\n\
        duration : 1,\n\
        complete : function() {\n\
            flightComplete = true;\n\
        },\n\
        easingFunction: Cesium.EasingFunction.LINEAR_NONE,\n\
    });';
    console.log(cameraString);
});

Sandcastle.addToolbarButton('Print view', function() {
    var cameraString = 'camera.position = new Cesium.Cartesian3(' + camera.positionWC.x + ', ' + camera.positionWC.y + ', ' + camera.positionWC.z + ');\n'+
                       'camera.direction = new Cesium.Cartesian3(' + camera.directionWC.x + ', ' + camera.directionWC.y + ', ' + camera.directionWC.z + ');\n'+
                       'camera.right = new Cesium.Cartesian3(' + camera.rightWC.x + ', ' + camera.rightWC.y + ', ' + camera.rightWC.z + ');\n'+
                       'camera.up = new Cesium.Cartesian3(' + camera.upWC.x + ', ' + camera.upWC.y + ', ' + camera.upWC.z + ');\n';
    console.log(cameraString);
});//Sandcastle_End
    Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
    startup(Cesium);
} else if (typeof require === "function") {
    require(["Cesium"], startup);
}
</script>
</body>
</html>
