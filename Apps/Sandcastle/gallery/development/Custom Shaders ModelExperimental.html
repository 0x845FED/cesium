<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta name="description" content="Create 3D models using glTF." />
    <meta name="cesium-sandcastle-labels" content="Development" />
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script
      type="text/javascript"
      src="../../../Build/CesiumUnminified/Cesium.js"
      nomodule
    ></script>
    <script type="module" src="../load-cesium-es6.js"></script>
  </head>
  <body
    class="sandcastle-loading"
    data-sandcastle-bucket="bucket-requirejs.html"
  >
    <style>
      @import url(../templates/bucket.css);
      #toolbar {
        background: rgba(42, 42, 42, 0.8);
        padding: 4px;
        border-radius: 4px;
      }
      #toolbar input {
        vertical-align: middle;
        padding-top: 2px;
        padding-bottom: 2px;
      }
    </style>
    <div id="cesiumContainer" class="fullSize"></div>
    <div id="loadingOverlay"><h1>Loading...</h1></div>
    <div id="toolbar"></div>
    <script id="cesium_sandcastle_script">
      function startup(Cesium) {
        "use strict";
        //Sandcastle_Begin
        Cesium.ExperimentalFeatures.enableModelExperimental = true;
        var viewer = new Cesium.Viewer("cesiumContainer");

        // Model positioning ===============================================

        var position = Cesium.Cartesian3.fromDegrees(
          -123.0744619,
          44.0503706,
          0
        );
        var hpr = new Cesium.HeadingPitchRoll(0, 0, 0);
        var fixedFrameTransform = Cesium.Transforms.localFrameToFixedFrameGenerator(
          "north",
          "west"
        );

        // Custom Shader Definitions ========================================

        // Dragging the mouse will expand/shrink the model.
        var expandModelShader = new Cesium.CustomShader({
          uniforms: {
            // Vector from latest drag center to the mouse
            u_drag: {
              type: Cesium.UniformType.VEC2,
              value: new Cesium.Cartesian2(0.0, 0.0),
            },
          },
          vertexShaderText: [
            // If the mouse is dragged to the right, the model grows
            // If the mouse is dragged to the left, the model shrinks
            "void vertexMain(VertexInput vsInput, inout vec3 position)",
            "{",
            "    position += 0.01 * u_drag.x * vsInput.attributes.normal;",
            "}",
          ].join("\n"),
        });

        var textureUniformShader = new Cesium.CustomShader({
          uniforms: {
            // elapsed time in seconds for animation
            u_time: {
              type: Cesium.UniformType.FLOAT,
              value: 0,
            },
            // user-defined texture
            u_stripes: {
              type: Cesium.UniformType.SAMPLER_2D,
              value: new Cesium.TextureUniform({
                url: "../../SampleData/cesium_stripes.png",
              }),
            },
          },
          // Apply the texture to the model, but move the texture coordinates
          // a bit over time so it's animated.
          fragmentShaderText: [
            "void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material)",
            "{",
            "    vec2 texCoord = fsInput.attributes.texCoord_0 + 0.1 * vec2(u_time, 0.0);",
            "    material.diffuse = texture2D(u_stripes, texCoord).rgb;",
            "}",
          ].join("\n"),
        });

        // Demos ==============================================================

        var models = {
          balloon: "../../SampleData/models/CesiumBalloon/CesiumBalloon.glb",
          drone: "../../SampleData/models/CesiumDrone/CesiumDrone.glb",
          pawns: "../../SampleData/models/CesiumDrone/Pawns.glb",
          milkTruck:
            "../../SampleData/models/CesiumMilkTruck/CesiumMilkTruck.glb",
          groundVehicle:
            "../../SampleData/models/GroundVehicle/GroundVehicle.glb",
        };

        var needsDrag = false;
        var demos = [
          {
            text: "Custom Texture",
            onselect: function () {
              selectModel(models.groundVehicle, textureUniformShader);
              needsDrag = false;
            },
          },
          {
            text: "Expand Model via Mouse Drag",
            onselect: function () {
              selectModel(models.milkTruck, expandModelShader);
              needsDrag = true;
            },
          },
        ];

        function selectModel(url, customShader) {
          viewer.scene.primitives.removeAll();
          var model = viewer.scene.primitives.add(
            Cesium.ModelExperimental.fromGltf({
              gltf: url,
              customShader: customShader,
              modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(
                position,
                hpr,
                Cesium.Ellipsoid.WGS84,
                fixedFrameTransform
              ),
            })
          );

          model.readyPromise.then(function (model) {
            viewer.camera.flyToBoundingSphere(model.boundingSphere, {
              duration: 0.5,
            });
          });
        }
        Sandcastle.addToolbarMenu(demos);

        // Event handlers =====================================================

        var startTime = performance.now();
        viewer.scene.postUpdate.addEventListener(function () {
          var elapsedTimeSeconds = (performance.now() - startTime) / 1000;
          textureUniformShader.setUniform("u_time", elapsedTimeSeconds);
        });

        var dragActive = false;
        var dragCenter = new Cesium.Cartesian2();

        viewer.screenSpaceEventHandler.setInputAction(function (movement) {
          if (!needsDrag) {
            return;
          }

          var pickedFeature = viewer.scene.pick(movement.position);
          if (!Cesium.defined(pickedFeature)) {
            return;
          }

          viewer.scene.screenSpaceCameraController.enableInputs = false;

          // set the new drag center
          dragActive = true;
          movement.position.clone(dragCenter);
        }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

        var scratchDrag = new Cesium.Cartesian2();
        viewer.screenSpaceEventHandler.setInputAction(function (movement) {
          if (!needsDrag) {
            return;
          }

          if (dragActive) {
            // get the mouse position relative to the center of the screen
            var drag = Cesium.Cartesian3.subtract(
              movement.endPosition,
              dragCenter,
              scratchDrag
            );

            // Update uniforms
            expandModelShader.setUniform("u_drag", drag);
          }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        viewer.screenSpaceEventHandler.setInputAction(function (movement) {
          if (!needsDrag) {
            return;
          }

          viewer.scene.screenSpaceCameraController.enableInputs = true;

          dragActive = false;
        }, Cesium.ScreenSpaceEventType.LEFT_UP);

        //Sandcastle_End
        Sandcastle.finishedLoading();
      }
      if (typeof Cesium !== "undefined") {
        window.startupCalled = true;
        startup(Cesium);
      }
    </script>
  </body>
</html>
